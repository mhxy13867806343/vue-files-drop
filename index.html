<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Êñá‰ª∂Â§πÁÆ°ÁêÜÂô®</title>
  <!-- Vue 3.2 CDN -->
  <script src="https://unpkg.com/vue@3.2.47/dist/vue.global.js"></script>
  <!-- Element Plus -->
  <link rel="stylesheet" href="https://unpkg.com/element-plus@2.3.7/dist/index.css" />
  <script src="https://unpkg.com/element-plus@2.3.7/dist/index.full.js"></script>
  <script src="https://unpkg.com/@element-plus/icons-vue"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Microsoft YaHei', sans-serif;
      background-color: #f5f5f5;
      color: #333;
    }
    
    .app-container {
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    
    .header-buttons {
      display: flex;
      gap: 10px;
    }
    
    .btn-action {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }
    
    .btn-action:hover {
      opacity: 0.9;
    }
    
    .btn-save {
      background-color: #4CAF50;
      color: white;
    }
    
    .drag-area {
      border: 2px dashed #ccc;
      background-color: rgba(0, 0, 0, 0.02);
    }
    
    .drag-active {
      border-color: #4CAF50;
      background-color: rgba(76, 175, 80, 0.1);
    }
    
    .folder-container {
      position: relative;
      min-height: 400px;
      padding: 20px;
      border: 1px dashed #ddd;
      border-radius: 4px;
      user-select: none;
    }
    
    .folders-list {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }
    
    .folder-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: auto;
      height: 100px;
      padding: 10px;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      z-index: 1;
      user-select: none; /* Èò≤Ê≠¢ÊãñÂä®Êó∂ÈÄâÊã©ÊñáÊú¨ */
    }
    
    .folder-item.dragging {
      opacity: 0.7;
      transform: scale(1.05);
      z-index: 10;
    }
    
    .folder-item.drag-over {
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
      background-color: rgba(0, 0, 0, 0.05);
    }
    
    .folder-item:hover {
      background-color: rgba(0, 0, 0, 0.05);
    }
    
    .folder-item.hover {
      background-color: rgba(0, 0, 0, 0.08);
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
    }
    
    .folder-item.selected {
      background-color: rgba(25, 118, 210, 0.2);
      outline: 3px solid #1976d2;
      box-shadow: 0 0 8px rgba(25, 118, 210, 0.5);
    }
    
    .folder-item.selected.hover {
      background-color: rgba(25, 118, 210, 0.25);
    }
    
    .selection-info {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(25, 118, 210, 0.1);
      border: 1px solid #1976d2;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 14px;
      color: #1976d2;
      z-index: 100;
    }
    
    .selection-box {
      position: fixed;
      border: 2px solid rgba(25, 118, 210, 0.8);
      background-color: rgba(25, 118, 210, 0.15);
      z-index: 90;
      pointer-events: none;
      box-shadow: 0 0 10px rgba(25, 118, 210, 0.4);
    }
    
    .selection-actions {
      display: flex;
      gap: 8px;
    }
    
    .selection-actions button {
      padding: 2px 8px;
      border: none;
      border-radius: 3px;
      background-color: #4CAF50;
      color: white;
      cursor: pointer;
      font-size: 12px;
    }
    
    .selection-actions button.delete {
      background-color: #f44336;
    }
    
    .keyboard-shortcuts {
      margin-top: 10px;
      padding: 10px;
      background-color: #f5f5f5;
      border-radius: 4px;
      font-size: 12px;
      line-height: 1.6;
    }
    
    .folder-icon {
      font-size: 40px;
      color: #ffc107;
      margin-bottom: 8px;
    }
    
    .folder-name {
      font-size: 14px;
      text-align: center;
      word-break: break-word;
      overflow: hidden;
      max-height: 42px;
      width: 100%;
    }
    
    .folder-name-input {
      width: 100%;
      padding: 4px 6px;
      text-align: center;
      border: 1px solid #ddd;
      border-radius: 3px;
      outline: none;
      font-size: 14px;
    }
    
    .context-menu {
      position: fixed;
      background: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      min-width: 200px;
      font-size: 14px;
    }
    
    .menu-item {
      padding: 10px 15px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .menu-item:hover {
      background-color: #f5f5f5;
    }
    
    .empty-text {
      text-align: center;
      padding: 40px 0;
      color: #999;
      font-style: italic;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    
    .hint {
      margin-top: 20px;
      color: #666;
      font-size: 13px;
      padding: 10px;
      background-color: #f0f8ff;
      border-radius: 4px;
      line-height: 1.6;
    }
    
    .file-icon {
      color: #2196F3;
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="app-container">
      <div class="header">
        <h2>Êñá‰ª∂Â§πÁÆ°ÁêÜÂô®({{folders.length}})</h2>
        <div class="header-buttons">
          <el-button @click="createNewFolder" class="btn-action">Êñ∞Âª∫Êñá‰ª∂Â§π</el-button>
          <el-button
          v-if="folders.length"
          @click="saveData" class="btn-action btn-save">‰øùÂ≠ò</el-button>
          <el-button
          v-if="folders.length"
          type="warning"
          @click="clearData" class="btn-action btn-save">Ê∏ÖÈô§</el-button>
        </div>
      </div>

      <div 
        class="folder-container" 
        @click="handleContainerClick($event)"
        @contextmenu.prevent="showContextMenu($event)"
        @mousedown="startDragSelection($event)"
        @mousemove="updateDragSelection($event)"
        @mouseup="endDragSelection($event)"
        @mouseleave="endDragSelection($event)"
        @dragover="onDragOver"
        @dragleave="onDragLeave"
        @drop="onDrop"
        :class="{ 'drag-area': isDragging, 'drag-active': isDraggingActive }"
      >
        <!-- Êñá‰ª∂Â§πÂàóË°® -->
        <div v-if="folders.length > 0" class="folders-list">
          <div 
            v-for="(folder, index) in folders" 
            :key="folder.id" 
            class="folder-item"
            :data-id="folder.id"
            :class="{ 
              'selected': selectedFolders.includes(folder.id),
              'hover': hoveredFolderId === folder.id,
              'dragging': draggedFolder && draggedFolder.id === folder.id,
              'drag-over': dragOverFolder && dragOverFolder.id === folder.id
            }"
            @click.stop="handleFolderClick(folder, index, $event)"
            @contextmenu.stop.prevent="showContextMenu($event, folder)"
            @dblclick="startEdit(folder)"
            @mouseover="onFolderMouseOver(folder)"
            @mouseleave="onFolderMouseLeave(folder)"
            draggable="true"
            @dragstart="handleDragStart($event, folder, index)"
            @dragover.prevent="handleDragOver($event, folder, index)"
            @drop.prevent="handleDrop($event, folder, index)"
          >
            <template v-if="editingFolder && editingFolder.id === folder.id">
              <div class="folder-icon" :class="{'file-icon': folder.isFile}">{{ folder.isFile ? 'üìÑ' : 'üìÅ' }}</div>
              <input 
                ref="editInput"
                v-model="editingFolder.name" 
                @blur="finishEdit" 
                @keyup.enter="finishEdit"
                @keyup.esc="cancelEdit"
                class="folder-name-input"
                v-focus
              />
            </template>
            <template v-else>
              <div class="folder-icon" :class="{'file-icon': folder.isFile}">{{ folder.isFile ? 'üìÑ' : 'üìÅ' }}</div>
              <div class="folder-name">{{ folder.name }}</div>
            </template>
          </div>
        </div>
        
        <!-- Á©∫Áä∂ÊÄÅ -->
        <div v-else class="empty-text">
          Âè≥ÈîÆÁÇπÂáªÂàõÂª∫‰∏Ä‰∏™Êñ∞ÁöÑÊñá‰ª∂Â§π
        </div>
        
        <!-- Ê°ÜÈÄâ -->
        <div 
          v-show="isSelectionActive"
          class="selection-box"
          :style="{
            left: `${Math.min(selectionStart.x, selectionCurrent.x)}px`,
            top: `${Math.min(selectionStart.y, selectionCurrent.y)}px`,
            width: `${Math.abs(selectionCurrent.x - selectionStart.x)}px`,
            height: `${Math.abs(selectionCurrent.y - selectionStart.y)}px`
          }"
        ></div>

        <!-- Âè≥ÈîÆËèúÂçï -->
        <div 
          v-show="contextMenuVisible" 
          class="context-menu"
          :style="{ top: contextMenuTop + 'px', left: contextMenuLeft + 'px' }"
        >
          <!-- ÈÄöÁî®ËèúÂçïÈ°π -->
          <div v-if="folders.length > 0" class="menu-item" @click="selectAllFolders">ÂÖ®ÈÄâ</div>
          <div v-if="selectedFolders.length > 0" class="menu-item" @click="clearSelection">ÂèñÊ∂àÈÄâÊã©</div>
          <div class="menu-item" @click="createNewFolder">ÂàõÂª∫Êñ∞Êñá‰ª∂Â§π</div>
          <div v-if="clipboardData" class="menu-item" @click="pasteFolder">Á≤òË¥¥</div>
          
          <!-- Â§öÈÄâÊ®°Âºè‰∏ãÁöÑËèúÂçïÈ°π -->
          <template v-if="selectedFolders.length > 1 && selectedFolder && selectedFolders.includes(selectedFolder.id)">
            <div class="menu-item" @click="copySelectedFolders">Â§çÂà∂ÈÄâ‰∏≠ÁöÑ {{selectedFolders.length}} ‰∏™È°πÁõÆ</div>
            <div class="menu-item" @click="deleteSelectedFolders">Âà†Èô§ÈÄâ‰∏≠ÁöÑ {{selectedFolders.length}} ‰∏™È°πÁõÆ</div>
          </template>
          
          <!-- ÂçïÈÄâÊ®°Âºè‰∏ãÁöÑËèúÂçïÈ°π -->
          <template v-else-if="selectedFolder">
            <div class="menu-item" @click="startEdit(selectedFolder)">ÈáçÂëΩÂêç</div>
            <div class="menu-item" @click="copyFolder(selectedFolder)">Â§çÂà∂</div>
            <div class="menu-item" @click="deleteFolder(selectedFolder)">Âà†Èô§</div>
          </template>
        </div>
      </div>
      
      <div class="hint">
        <strong>ÊèêÁ§∫Ôºö</strong><br>
        - Âè≥ÈîÆÁÇπÂáªÁ©∫ÁôΩÂå∫ÂüüÂàõÂª∫Êñ∞Êñá‰ª∂Â§π<br>
        - ÂèåÂáªÊñá‰ª∂Â§πÂêçÁß∞ËøõË°å‰øÆÊîπ<br>
        - Âè≥ÈîÆÁÇπÂáªÊñá‰ª∂Â§πÂèØ‰ª•Â§çÂà∂„ÄÅÈáçÂëΩÂêçÊàñÂà†Èô§<br>
        - Â∞ÜÊñá‰ª∂Â§πÊãñÊãΩÂà∞Ê≠§Âå∫Âüü‰∏ä‰º†<br>
        - ÁÇπÂáª"‰øùÂ≠ò"ÊåâÈíÆÊàñÂÖ≥Èó≠È°µÈù¢Êó∂‰ºöËá™Âä®‰øùÂ≠ò<br>
        - Â§çÂà∂ÂêéÂèØ‰ª•Âú®Á©∫ÁôΩÂå∫ÂüüÂè≥ÈîÆÈÄâÊã©Á≤òË¥¥
      </div>
      
      <div class="keyboard-shortcuts">
        <strong>Êìç‰ΩúÊèêÁ§∫Ôºö</strong><br>
        - <kbd>Ctrl</kbd> + ÁÇπÂáªÔºöÂ§öÈÄâÊñá‰ª∂Â§π<br>
        - <kbd>Shift</kbd> + ÁÇπÂáªÔºöËøûÁª≠ÈÄâÊã©Êñá‰ª∂Â§π<br>
        - <kbd>Ctrl+A</kbd> Êàñ Âè≥ÈîÆËèúÂçïÂÖ®ÈÄâÔºöÈÄâÊã©ÊâÄÊúâÊñá‰ª∂Â§π<br>
        - <kbd>Ctrl+C</kbd> Êàñ Âè≥ÈîÆËèúÂçïÂ§çÂà∂ÔºöÂ§çÂà∂ÈÄâ‰∏≠Êñá‰ª∂Â§π<br>
        - <kbd>Ctrl+V</kbd> Êàñ Âè≥ÈîÆËèúÂçïÁ≤òË¥¥ÔºöÁ≤òË¥¥Êñá‰ª∂Â§π<br>
        - <kbd>Delete</kbd> Êàñ Âè≥ÈîÆËèúÂçïÂà†Èô§ÔºöÂà†Èô§ÈÄâ‰∏≠Êñá‰ª∂Â§π<br>
        - <kbd>Esc</kbd> Êàñ Á©∫ÁôΩÂå∫ÂüüÁÇπÂáª Êàñ Âè≥ÈîÆËèúÂçïÂèñÊ∂àÈÄâÊã©ÔºöÂèñÊ∂àÈÄâÊã©
      </div>
      
      <!-- ÈÄâ‰∏≠‰ø°ÊÅØÊèêÁ§∫ -->
      <div v-if="selectedFolders.length > 0" class="selection-info">
        Â∑≤ÈÄâÊã© {{ selectedFolders.length }} ‰∏™È°πÁõÆ
        <div class="selection-actions">
          <button @click="copySelectedFolders">Â§çÂà∂</button>
          <button class="delete" @click="deleteSelectedFolders">Âà†Èô§</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const { createApp, ref, nextTick, onMounted, onBeforeUnmount } = Vue;
    // Ëá™ÂÆö‰πâÊåá‰ª§ÔºöËá™Âä®ËÅöÁÑ¶
    const vFocus = {
      mounted: (el) => el.focus()
    };

    const app = createApp({
      directives: {
        focus: vFocus
      },
      setup() {
        // Êñá‰ª∂Â§πÊï∞ÊçÆ
        const folders = ref([]);
        let nextId = 1;
        
        // ÊãñÊãΩÁä∂ÊÄÅ
        const isDragging = ref(false);
        const isDraggingActive = ref(false);
        
        // ÂèòÊõ¥Ë∑üË∏™
        const hasChanges = ref(false);
        const originalData = ref('');
        
        // Â§çÂà∂Á≤òË¥¥Áä∂ÊÄÅ
        const clipboardData = ref(null);
        
        // Â§öÈÄâÂäüËÉΩ
        const selectedFolders = ref([]);
        const ctrlKeyPressed = ref(false);
        const shiftKeyPressed = ref(false);
        const lastSelectedIndex = ref(-1);
        
        // Èº†Ê†áÊÇ¨ÂÅúÁä∂ÊÄÅ
        const hoveredFolderId = ref(null);
        
        // Ê°ÜÈÄâÁä∂ÊÄÅ
        const isSelectionActive = ref(false);
        const selectionStart = ref({ x: 0, y: 0 });
        const selectionCurrent = ref({ x: 0, y: 0 });
        const folderElements = ref([]);
        
        // ÊãñÊãΩÁä∂ÊÄÅ
        const draggedFolder = ref(null);
        const dragOverFolder = ref(null);
        const isDraggingFolder = ref(false);
        const dragStartX = ref(0);
        const dragStartY = ref(0);

        // Âè≥ÈîÆËèúÂçïÁä∂ÊÄÅ
        const contextMenuVisible = ref(false);
        const contextMenuTop = ref(0);
        const contextMenuLeft = ref(0);
        const selectedFolder = ref(null);

        // ÁºñËæëÁä∂ÊÄÅ
        const editingFolder = ref(null);
        const editInput = ref(null);
        const tempName = ref('');

        // ÊòæÁ§∫Âè≥ÈîÆËèúÂçï
        const showContextMenu = (event, folder = null) => {
          // ËÆ°ÁÆóËèúÂçï‰ΩçÁΩÆ
          contextMenuTop.value = event.clientY;
          contextMenuLeft.value = event.clientX;
          
          // Á°Æ‰øùËèúÂçï‰∏ç‰ºöË∂ÖÂá∫ËßÜÂè£
          const viewportHeight = window.innerHeight;
          const viewportWidth = window.innerWidth;
          // Âä®ÊÄÅËÆ°ÁÆóËèúÂçïÈ´òÂ∫¶
          let menuHeight = 40; // ÈªòËÆ§‰ªÖÊúâÂàõÂª∫Êñá‰ª∂Â§π
          
          if (clipboardData.value && !folder) menuHeight += 40; // Âä†‰∏äÁ≤òË¥¥ÈÄâÈ°π
          if (folder) {
            if (selectedFolders.length > 1 && selectedFolders.includes(folder.id)) {
              menuHeight = 120; // Â§öÈÄâÊ®°Âºè‰∏ãÁöÑËèúÂçïÈ´òÂ∫¶
            } else {
              menuHeight = 160; // ÂçïÈÄâÊ®°Âºè‰∏ãÁöÑËèúÂçïÈ´òÂ∫¶
            }
          }
          
          const menuWidth = 240; // Â¢ûÂä†ËèúÂçïÂÆΩÂ∫¶‰ª•ÈÄÇÂ∫îÊñáÂ≠ó
          
          if (contextMenuTop.value + menuHeight > viewportHeight) {
            contextMenuTop.value = viewportHeight - menuHeight;
          }
          
          if (contextMenuLeft.value + menuWidth > viewportWidth) {
            contextMenuLeft.value = viewportWidth - menuWidth;
          }
          
          contextMenuVisible.value = true;
          selectedFolder.value = folder;
          
          // Â¶ÇÊûúÂè≥ÈîÆÁÇπÂáªÁöÑÊòØÊú™ÈÄâ‰∏≠ÁöÑÊñá‰ª∂Â§πÔºåËÄå‰∏îÊ≤°ÊúâÊåâ‰∏ãCtrlÈîÆÔºåÂàôÊ∏ÖÈô§ÂΩìÂâçÈÄâÊã©Âπ∂ÈÄâ‰∏≠ËØ•Êñá‰ª∂Â§π
          if (folder && !selectedFolders.value.includes(folder.id) && !ctrlKeyPressed.value) {
            selectedFolders.value = [folder.id];
            const index = folders.value.findIndex(f => f.id === folder.id);
            if (index !== -1) {
              lastSelectedIndex.value = index;
            }
          }
        };

        // ÂàõÂª∫Êñ∞Êñá‰ª∂Â§π
        const createNewFolder = () => {
          if (folders.value.length >= 20) {
            ElementPlus.ElMessage.info("ÊúÄÂ§öÊñá‰ª∂Â§πÂè™ËÉΩÂàõÂª∫ 20 ‰∏™,ËØ∑ÂÖàÁßªÈô§ÈÉ®ÂàÜÂêéÔºåÂÜçÊ∑ªÂä†!")
            contextMenuVisible.value = false;
            return;
          }
          
          // ÁîüÊàêÊñ∞Êñá‰ª∂Â§πÂêç
          let baseName = 'Êñ∞Âª∫Êñá‰ª∂Â§π';
          let folderName = baseName;
          let counter = 1;
          
          // Ê£ÄÊü•ÊòØÂê¶ÊúâÈáçÂêçÊñá‰ª∂Â§πÔºåÂ¶ÇÊûúÊúâÂ∞±Ëá™Âä®ËøΩÂä†Êï∞Â≠ó
          while (folders.value.some(f => f.name === folderName)) {
            folderName = `${baseName}${counter}`;
            counter++;
          }
          
          const newFolder = { 
            id: nextId++, 
            name: folderName
          };
          
          folders.value.push(newFolder);
          contextMenuVisible.value = false;
          hasChanges.value = true;
          
          ElementPlus.ElMessage({
            message: `ÊàêÂäüÂàõÂª∫„Äå${folderName}„Äç`,
            type: 'success',
            duration: 1500
          });
          
          // ÂàõÂª∫ÂêéÁ´ãÂç≥ËøõÂÖ•ÁºñËæëÊ®°Âºè
          nextTick(() => {
            startEdit(newFolder);
          });
        };

        // ÂºÄÂßãÁºñËæëÊñá‰ª∂Â§πÂêçÁß∞
        const startEdit = (folder) => {
          tempName.value = folder.name;
          editingFolder.value = { ...folder };
          contextMenuVisible.value = false;
          
          // Á°Æ‰øùËæìÂÖ•Ê°ÜËé∑ÂæóÁÑ¶ÁÇπ
          nextTick(() => {
            // editInputÊòØ‰∏Ä‰∏™Êï∞ÁªÑÔºåÊàë‰ª¨Ëé∑ÂèñÁ¨¨‰∏Ä‰∏™ÂÖÉÁ¥†
            if (editInput.value && editInput.value.length > 0) {
              // ÂØπ‰∫éÊï∞ÁªÑ‰∏≠ÁöÑÊØè‰∏™ÂÖÉÁ¥†ÈÉΩÂ∞ùËØïÂ∫îÁî®focus
              editInput.value.forEach(input => {
                if (input && typeof input.focus === 'function') {
                  input.focus();
                  input.select();
                }
              });
            } else if (editInput.value && typeof editInput.value.focus === 'function') {
              // Â¶ÇÊûú‰∏çÊòØÊï∞ÁªÑ‰ΩÜÊòØÊòØÂçï‰∏™ÂÖÉÁ¥†
              editInput.value.focus();
              editInput.value.select();
            }
          });
        };

        // ÂÆåÊàêÁºñËæë
        const finishEdit = () => {
          if (editingFolder.value) {
            const index = folders.value.findIndex(f => f.id === editingFolder.value.id);
            if (index !== -1) {
              // È™åËØÅÂêçÁß∞‰∏ç‰∏∫Á©∫
              if (editingFolder.value.name.trim() === '') {
                editingFolder.value.name = tempName.value;
                ElementPlus.ElMessage.warning('Êñá‰ª∂Â§πÂêçÁß∞‰∏çËÉΩ‰∏∫Á©∫');
              } else {
                // Ê£ÄÊü•ÊòØÂê¶Â≠òÂú®ÈáçÂêç
                const trimmedName = editingFolder.value.name.trim();
                const duplicateName = folders.value.find(
                  f => f.id !== editingFolder.value.id && f.name === trimmedName
                );
                
                if (duplicateName) {
                  ElementPlus.ElMessage.error('Êñá‰ª∂Â§πÂêçÁß∞„Äå' + trimmedName + '„ÄçÂ∑≤Â≠òÂú®ÔºåËØ∑‰ΩøÁî®ÂÖ∂‰ªñÂêçÁß∞');
                  editingFolder.value.name = tempName.value;
                } else if (folders.value[index].name !== trimmedName) {
                  // Âè™ÊúâÂΩìÂêçÁß∞ÁúüÁöÑÊîπÂèòÊó∂ÊâçÊ†áËÆ∞ÂèòÊõ¥
                  folders.value[index].name = trimmedName;
                  hasChanges.value = true;
                  ElementPlus.ElMessage({
                    message: 'Êñá‰ª∂Â§πÈáçÂëΩÂêçÊàêÂäü',
                    type: 'success'
                  });
                }
              }
            }
            editingFolder.value = null;
          }
        };

        // ÂèñÊ∂àÁºñËæë
        const cancelEdit = () => {
          editingFolder.value = null;
        };

        // Âà†Èô§Êñá‰ª∂Â§π
        const deleteFolder = (folder) => {
          ElementPlus.ElMessageBox.confirm(
            `Á°ÆÂÆöË¶ÅÂà†Èô§Êñá‰ª∂Â§π„Äå${folder.name}„ÄçÂêóÔºü`,
            'Âà†Èô§Á°ÆËÆ§',
            {
              confirmButtonText: 'Á°ÆÂÆöÂà†Èô§',
              cancelButtonText: 'ÂèñÊ∂à',
              type: 'warning'
            }
          ).then(() => {
            const index = folders.value.findIndex(f => f.id === folder.id);
            if (index !== -1) {
              folders.value.splice(index, 1);
              contextMenuVisible.value = false;
              hasChanges.value = true;
              ElementPlus.ElMessage({
                message: `Êñá‰ª∂Â§π„Äå${folder.name}„ÄçÂ∑≤ÊàêÂäüÂà†Èô§`,
                type: 'success'
              });
            }
          }).catch(() => {
            contextMenuVisible.value = false;
            ElementPlus.ElMessage({
              type: 'info',
              message: 'Â∑≤ÂèñÊ∂àÂà†Èô§'
            });
          });
        };

        // Â§ÑÁêÜÂÆπÂô®ÁÇπÂáª‰∫ã‰ª∂
        const handleContainerClick = (event) => {
          // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØÂÆπÂô®Êú¨Ë∫´ÔºåËÄå‰∏çÊòØÂÆπÂô®ÂÜÖÁöÑÊñá‰ª∂Â§π
          if (event.target === event.currentTarget) {
            // Â¶ÇÊûúÊ≤°ÊúâÊåâ‰∏ãCtrlÈîÆÔºåÊ∏ÖÈô§ÈÄâ‰∏≠Áä∂ÊÄÅ
            if (!ctrlKeyPressed.value && !shiftKeyPressed.value) {
              selectedFolders.value = [];
              lastSelectedIndex.value = -1;
            }
          }
        };
        
        // Èº†Ê†áÊÇ¨ÂÅúÂú®Êñá‰ª∂Â§π‰∏ä
        const onFolderMouseOver = (folder) => {
          hoveredFolderId.value = folder.id;
        };
        
        // Èº†Ê†áÁßªÂá∫Êñá‰ª∂Â§π
        const onFolderMouseLeave = (folder) => {
          if (hoveredFolderId.value === folder.id) {
            hoveredFolderId.value = null;
          }
        };
        
        // ÂÖ®ÈÄâÊñá‰ª∂Â§π
        const selectAllFolders = () => {
          if (folders.value.length > 0) {
            selectedFolders.value = folders.value.map(f => f.id);
            lastSelectedIndex.value = folders.value.length - 1;
            ElementPlus.ElMessage({
              message: `Â∑≤ÈÄâÊã©ÂÖ®ÈÉ® ${folders.value.length} ‰∏™È°πÁõÆ`,
              type: 'success',
              duration: 1500
            });
          }
          contextMenuVisible.value = false;
        };
        
        // Ê∏ÖÈô§ÈÄâ‰∏≠Áä∂ÊÄÅ
        const clearSelection = () => {
          selectedFolders.value = [];
          lastSelectedIndex.value = -1;
          contextMenuVisible.value = false;
        };
        
        // ÂºÄÂßãÊãñÊãΩÊñá‰ª∂Â§π
        const onFolderDragStart = (event, folder, index) => {
          // Â¶ÇÊûúÊ≠£Âú®ÁºñËæëÊñá‰ª∂Â§πÔºå‰∏çÂÖÅËÆ∏ÊãñÊãΩ
          if (editingFolder.value) return;
          
          // Â¶ÇÊûúÊ≠£Âú®Ê°ÜÈÄâÔºå‰∏çÂÖÅËÆ∏ÊãñÊãΩ
          if (isSelectionActive.value) return;
          
          // Âè™ÊúâÈº†Ê†áÂ∑¶ÈîÆÂèØ‰ª•ÊãñÊãΩ
          if (event.button !== 0) return;
          
          // ËÆ∞ÂΩïÈº†Ê†áÂùêÊ†áÂÖÅËÆ∏Âà§Êñ≠ÁßªÂä®Ë∑ùÁ¶ª
          dragStartX.value = event.clientX;
          dragStartY.value = event.clientY;
          
          // Ê∑ªÂä†ÊñáÊ°£Á∫ß‰∫ã‰ª∂ÁõëÂê¨
          document.addEventListener('mousemove', checkDragThreshold);
          document.addEventListener('mouseup', cancelDragStart);
          
          // Ê£ÄÊü•Áî®Êà∑‰∏ÄÂÆöË∑ùÁ¶ªÂêéÂºÄÂßãÊãñÊãΩ (ÈÅøÂÖçÁÇπÂáªË¢´ËØØËÆ§‰∏∫ÊãñÊãΩ)
          function checkDragThreshold(e) {
            const dx = Math.abs(e.clientX - dragStartX.value);
            const dy = Math.abs(e.clientY - dragStartY.value);
            
            // Â¶ÇÊûúÁßªÂä®5ÂÉèÁ¥†‰ª•‰∏äÔºåËÆ§‰∏∫ÊòØÊãñÊãΩÊìç‰Ωú
            if (dx > 5 || dy > 5) {
              document.removeEventListener('mousemove', checkDragThreshold);
              document.removeEventListener('mouseup', cancelDragStart);
              
              // Ê†áËÆ∞ÊãñÊãΩÁä∂ÊÄÅ
              isDraggingFolder.value = true;
              draggedFolder.value = folder;
              
              // Ê∑ªÂä†ÊñáÊ°£Á∫ßÁöÑ‰∫ã‰ª∂Â§ÑÁêÜ
              document.addEventListener('mousemove', handleDocumentMouseMove);
              document.addEventListener('mouseup', handleDocumentMouseUp);
            }
          }
          
          function cancelDragStart() {
            document.removeEventListener('mousemove', checkDragThreshold);
            document.removeEventListener('mouseup', cancelDragStart);
          }
          
          function handleDocumentMouseMove(e) {
            if (!isDraggingFolder.value) return;
            
            // ÈòªÊ≠¢ÈªòËÆ§Ë°å‰∏∫
            e.preventDefault();
            
            // Ëé∑ÂèñÂΩìÂâçÈº†Ê†á‰ΩçÁΩÆ‰∏ãÁöÑÂÖÉÁ¥†
            const elementsUnderCursor = document.elementsFromPoint(e.clientX, e.clientY);
            
            // Êü•ÊâæÂÖÉÁ¥†‰∏ãÁöÑÊñá‰ª∂Â§πÂÖÉÁ¥†
            const folderElement = elementsUnderCursor.find(el => 
              el.classList.contains('folder-item') && 
              (!draggedFolder.value || el.getAttribute('data-id') !== draggedFolder.value.id)
            );
            
            // Â¶ÇÊûúÈº†Ê†á‰∏ãÊúâÊñá‰ª∂Â§πÂÖÉÁ¥†ÔºåÊõ¥Êñ∞ÊÇ¨ÊµÆÊñá‰ª∂Â§π
            if (folderElement) {
              const folderId = folderElement.getAttribute('data-id');
              dragOverFolder.value = folders.value.find(f => f.id.toString() === folderId);
            } else {
              dragOverFolder.value = null;
            }
          }
          
          function handleDocumentMouseUp(e) {
            // ÁßªÈô§ÊñáÊ°£Á∫ß‰∫ã‰ª∂ÁõëÂê¨
            document.removeEventListener('mousemove', handleDocumentMouseMove);
            document.removeEventListener('mouseup', handleDocumentMouseUp);
            
            // Â¶ÇÊûúÊ≤°ÊúâÂÆåÊàêÊãñÊãΩÔºåÁõ¥Êé•ËøîÂõû
            if (!isDraggingFolder.value) return;
            
            // Â¶ÇÊûúÊúâÁõÆÊ†áÊñá‰ª∂Â§πÔºåËøõË°å‰∫§Êç¢
            if (dragOverFolder.value && draggedFolder.value) {
              swapFolders(draggedFolder.value, dragOverFolder.value);
            }
            
            // ÈáçÁΩÆÊãñÊãΩÁä∂ÊÄÅ
            isDraggingFolder.value = false;
            draggedFolder.value = null;
            dragOverFolder.value = null;
          }
        };
        
        // ÂÆûÁé∞HTML5ÂéüÁîüÊãñÊãΩÂäüËÉΩ
        
        // ÂºÄÂßãÊãñÊãΩ
        const handleDragStart = (event, folder, index) => {
          // Â¶ÇÊûúÊ≠£Âú®ÁºñËæëÊñá‰ª∂Â§πÔºå‰∏çÂÖÅËÆ∏ÊãñÊãΩ
          if (editingFolder.value) {
            event.preventDefault();
            return;
          }
          
          // Â¶ÇÊûúÊ≠£Âú®Ê°ÜÈÄâÔºå‰∏çÂÖÅËÆ∏ÊãñÊãΩ
          if (isSelectionActive.value) {
            event.preventDefault();
            return;
          }
          
          // ËÆæÁΩÆÊãñÊãΩÊï∞ÊçÆ
          event.dataTransfer.effectAllowed = 'move';
          event.dataTransfer.setData('text/plain', folder.id);
          
          // ËÆ∞ÂΩïÂΩìÂâçÊãñÊãΩÁöÑÊñá‰ª∂Â§π
          draggedFolder.value = folder;
          
          // Ê∑ªÂä†Ê†∑ÂºèÊ†áËÆ∞ÊãñÊãΩ‰∏≠
          event.target.classList.add('dragging');
          
          // ËÆæÁΩÆÂçäÈÄèÊòéÊïàÊûú
          setTimeout(() => {
            event.target.style.opacity = '0.4';
          }, 0);
        };
        
        // ÊãñÊãΩÁªèËøáÂÖ∂‰ªñÊñá‰ª∂Â§π‰∏äÊñπ
        const handleDragOver = (event, folder, index) => {
          // Â¶ÇÊûúÊ≤°ÊúâÂú®ÊãñÊãΩÊñá‰ª∂Â§πÔºåÂàôÂøΩÁï•
          if (!draggedFolder.value) return;
          
          // ‰∏çËÉΩÊãñÊãΩÂà∞Ëá™Â∑±‰∏äÈù¢
          if (draggedFolder.value.id === folder.id) return;
          
          // Èò≤Ê≠¢ÈªòËÆ§Ë°å‰∏∫
          event.preventDefault();
          
          // ÁΩÆÁ©∫ÊïàÊûú‰∏∫ÁßªÂä®
          event.dataTransfer.dropEffect = 'move';
          
          // Êõ¥Êñ∞ÂΩìÂâçÊÇ¨ÊµÆÂú®Âì™‰∏™Êñá‰ª∂Â§π‰∏ä
          dragOverFolder.value = folder;
        };
        
        // Êîæ‰∏ãÂÆåÊàêÊãñÊãΩ
        const handleDrop = (event, folder, index) => {
          // Èò≤Ê≠¢ÈªòËÆ§Ë°å‰∏∫
          event.preventDefault();
          
          // Â¶ÇÊûúÊ≤°ÊúâÊãñÊãΩÁöÑÊñá‰ª∂Â§πÊàñËÄÖÊãñÊãΩÂà∞Ëá™Â∑±‰∏äÈù¢ÔºåÂàôÂøΩÁï•
          if (!draggedFolder.value || draggedFolder.value.id === folder.id) {
            return;
          }
          
          // Ëé∑ÂèñÊãñÊãΩÊñá‰ª∂Â§πID
          const draggedId = event.dataTransfer.getData('text/plain');
          const sourceFolder = folders.value.find(f => f.id.toString() === draggedId);
          
          // Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞Ê∫êÊñá‰ª∂Â§πÔºåÂàôÂøΩÁï•
          if (!sourceFolder) return;
          
          // ‰∫§Êç¢‰ΩçÁΩÆ
          swapFolders(sourceFolder, folder);
          
          // ÈáçÁΩÆÊãñÊãΩÁä∂ÊÄÅ
          draggedFolder.value = null;
          dragOverFolder.value = null;
        };
        
        // ‰∫§Êç¢‰∏§‰∏™Êñá‰ª∂Â§πÁöÑ‰ΩçÁΩÆ
        const swapFolders = (sourceFolder, targetFolder) => {
          // Ëé∑Âèñ‰∏§‰∏™Êñá‰ª∂Â§πÁöÑÁ¥¢Âºï
          const sourceIndex = folders.value.findIndex(f => f.id === sourceFolder.id);
          const targetIndex = folders.value.findIndex(f => f.id === targetFolder.id);
          
          // Ê£ÄÊü•ÊúâÊïàÊÄß
          if (sourceIndex < 0 || targetIndex < 0 || sourceIndex === targetIndex) return;
          
          // ÂàõÂª∫Êñ∞Êï∞ÁªÑÂπ∂ÈáçÊñ∞ÊéíÂ∫è
          const newFolders = [...folders.value];
          
          // ÂÖàÁßªÈô§Ê∫êÊñá‰ª∂Â§π
          const [removedFolder] = newFolders.splice(sourceIndex, 1);
          
          // ËÆ°ÁÆóÊèíÂÖ•Á¥¢ÂºïÔºàÊ†πÊçÆÂà†Èô§Êìç‰ΩúÂêéÁöÑÊï∞ÁªÑÁä∂ÊÄÅÔºâ
          let insertIndex = targetIndex;
          if (sourceIndex < targetIndex) {
            insertIndex--;
          }
          
          // Âú®ÁõÆÊ†á‰ΩçÁΩÆÊèíÂÖ•
          newFolders.splice(insertIndex + 1, 0, removedFolder);
          
          // Êõ¥Êñ∞Êñá‰ª∂Â§πÊï∞ÁªÑ
          folders.value = newFolders;
          
          // Ê†áËÆ∞Â∑≤‰øÆÊîπ
          hasChanges.value = true;
          
          // ‰øùÂ≠òÊï∞ÊçÆ
          saveData();
          
          // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
          ElementPlus.ElMessage({
            message: 'Êñá‰ª∂Â§πÈ°∫Â∫èÂ∑≤Êõ¥Êñ∞',
            type: 'success',
            duration: 1500
          });
        };
        
        // ÂºÄÂßãÊ°ÜÈÄâ
        const startDragSelection = (event) => {
          // Âè™ÊúâÂú®Â∑¶ÈîÆÁÇπÂáª‰∏îÁÇπÂáªÂú®ÂÆπÂô®Êú¨Ë∫´‰∏äÊó∂ÊâçÂêØÂä®Ê°ÜÈÄâ
          if (event.button !== 0 || event.target !== event.currentTarget) return;
          
          // ËÆ∞ÂΩïËµ∑ÂßãÁÇπÂùêÊ†á
          selectionStart.value = { 
            x: event.clientX, 
            y: event.clientY 
          };
          selectionCurrent.value = { 
            x: event.clientX, 
            y: event.clientY 
          };
          
          // È™åËØÅÊòØÂê¶ÊòØÂÆûÈôÖÁöÑÊãñÂä®Ë°å‰∏∫ÔºàÈò≤Ê≠¢ÂçïÂáªÊó∂Ëß¶ÂèëÔºâ
          document.addEventListener('mousemove', checkDragThreshold);
          document.addEventListener('mouseup', cancelDragCheck);
          
          function checkDragThreshold(e) {
            const dx = Math.abs(e.clientX - selectionStart.value.x);
            const dy = Math.abs(e.clientY - selectionStart.value.y);
            
            // Â¶ÇÊûúÁßªÂä®Ë∂ÖËøá5ÂÉèÁ¥†ÔºåËÆ§‰∏∫ÊòØÊãñÂä®Ë°å‰∏∫
            if (dx > 5 || dy > 5) {
              document.removeEventListener('mousemove', checkDragThreshold);
              document.removeEventListener('mouseup', cancelDragCheck);
              
              // ÊøÄÊ¥ªÊ°ÜÈÄâ
              isSelectionActive.value = true;
              
              // Â¶ÇÊûúÊ≤°ÊúâÊåâ‰∏ãCtrlÈîÆÔºåÊ∏ÖÈô§‰πãÂâçÁöÑÈÄâÊã©
              if (!ctrlKeyPressed.value && !shiftKeyPressed.value) {
                // Ê∏ÖÈô§Êï∞ÁªÑ
                selectedFolders.value = [];
                selectedFolder.value = null;
                
                // Ê∏ÖÈô§ÊâÄÊúâÈÄâ‰∏≠Ê†∑ÂºèÔºåÁ°Æ‰øùËßÜËßâ‰∏äÁöÑ‰∏ÄËá¥ÊÄß
                const items = document.querySelectorAll('.folder-item');
                items.forEach(item => {
                  item.classList.remove('selected');
                });
              }
            }
          }
          
          function cancelDragCheck() {
            document.removeEventListener('mousemove', checkDragThreshold);
            document.removeEventListener('mouseup', cancelDragCheck);
          }
          
          // ËÆ∞ÂΩïÊâÄÊúâÊñá‰ª∂Â§πÂÖÉÁ¥†ÁöÑ‰ΩçÁΩÆ
          const container = document.querySelector('.folder-container');
          const items = container.querySelectorAll('.folder-item');
          folderElements.value = Array.from(items).map((el, index) => {
            const rect = el.getBoundingClientRect();
            return {
              id: folders.value[index].id,
              left: rect.left,
              top: rect.top,
              right: rect.right,
              bottom: rect.bottom,
              element: el  // ‰øùÂ≠òDOMÂÖÉÁ¥†ÂºïÁî®‰ª•‰æøÁõ¥Êé•Êìç‰Ωú
            };
          });
        };
        
        // Êõ¥Êñ∞Ê°ÜÈÄâ
        const updateDragSelection = (event) => {
          if (!isSelectionActive.value) return;
          
          // Êõ¥Êñ∞ÂΩìÂâç‰ΩçÁΩÆ
          selectionCurrent.value = { x: event.clientX, y: event.clientY };
          
          // ËÆ°ÁÆóÈÄâÊã©Ê°ÜÁöÑÂùêÊ†á
          const selectionBox = {
            left: Math.min(selectionStart.value.x, selectionCurrent.value.x),
            top: Math.min(selectionStart.value.y, selectionCurrent.value.y),
            right: Math.max(selectionStart.value.x, selectionCurrent.value.x),
            bottom: Math.max(selectionStart.value.y, selectionCurrent.value.y)
          };
          
          // Âè™Âú®ÂºÄÂßãÊãñÂä®Êó∂Ëé∑Âèñ‰∏ÄÊ¨°ÂÖÉÁ¥†ÔºåÁÑ∂ÂêéÁºìÂ≠òÂÆÉ‰ª¨
          if (folderElements.value.length === 0) {
            const container = document.querySelector('.folder-container');
            const items = container.querySelectorAll('.folder-item');
            
            folderElements.value = Array.from(items).map((el, index) => {
              const rect = el.getBoundingClientRect();
              const folderId = folders.value[index].id;
              
              return {
                id: folderId,
                left: rect.left,
                top: rect.top,
                right: rect.right,
                bottom: rect.bottom,
                element: el,
                selected: selectedFolders.value.includes(folderId)
              };
            });
          }
          
          // ËÆ∞ÂΩïÊâÄÊúâÂ∑≤Êõ¥ÊîπÁöÑÊñá‰ª∂Â§πID
          const prevSelectedIds = [...selectedFolders.value];
          
          // Â¶ÇÊûú‰∏çÊòØÂ§öÈÄâÊ®°ÂºèÔºå‰∏¥Êó∂Ê∏ÖÁ©∫ÈÄâÊã©Êï∞ÁªÑÔºà‰ΩÜ‰∏çÂΩ±ÂìçUIÔºåUI‰ºöÂú®ÂêéÈù¢Êõ¥Êñ∞Ôºâ
          if (!ctrlKeyPressed.value && !shiftKeyPressed.value) {
            selectedFolders.value = [];
          }
          
          // Ê£ÄÊü•ÊØè‰∏™Êñá‰ª∂Â§πÊòØÂê¶Âú®ÈÄâÊã©Ê°ÜÂÜÖ
          folderElements.value.forEach(folder => {
            // Ê£ÄÊü•ÈáçÂè† - Âè™Ë¶ÅÊúâÈÉ®ÂàÜÈáçÂè†Â∞±ÁÆóÈÄâ‰∏≠
            const isIntersecting = !(folder.right < selectionBox.left || 
                                 folder.left > selectionBox.right || 
                                 folder.bottom < selectionBox.top || 
                                 folder.top > selectionBox.bottom);
            
            if (isIntersecting) {
              // Ê∑ªÂä†Âà∞ÈÄâ‰∏≠Êï∞ÁªÑ
              if (!selectedFolders.value.includes(folder.id)) {
                selectedFolders.value.push(folder.id);
              }
              
              // Êõ¥Êñ∞ËßÜËßâÊïàÊûú
              if (!folder.element.classList.contains('selected')) {
                folder.element.classList.add('selected');
                folder.selected = true;
              }
            } else if (!ctrlKeyPressed.value && !shiftKeyPressed.value) {
              // Â¶ÇÊûú‰∏çÂú®Ê°ÜÂÜÖ‰∏î‰∏çÊòØÂ§öÈÄâÊ®°ÂºèÔºåÂàôÁßªÈô§
              folder.element.classList.remove('selected');
              folder.selected = false;
            }
          });
          
          // Ëß¶Âèë‰∫ã‰ª∂ÂëäÁü•VueÂ∑≤Êõ¥Êñ∞DOM
          if (selectedFolders.value.length > 0) {
            // Â∞ùËØï‰ΩøÁî®Ëá™ÂÆö‰πâ‰∫ã‰ª∂ÈÄöÁü•VueÊõ¥Êñ∞
            window.dispatchEvent(new CustomEvent('selectionChanged', {
              detail: { selectedIds: selectedFolders.value }
            }));
          }
        };
        
        // ÁªìÊùüÊ°ÜÈÄâ
        const endDragSelection = (event) => {
          if (!isSelectionActive.value) return;
          
          // ÁªìÊùüÊ°ÜÈÄâÁä∂ÊÄÅ
          isSelectionActive.value = false;
          
          // Ê∏ÖÁ©∫ËÆ∞ÂΩïÁöÑÊñá‰ª∂Â§πÂÖÉÁ¥†Êï∞ÁªÑÔºå‰∏ãÊ¨°ÈáçÊñ∞Ëé∑Âèñ
          folderElements.value = [];
          
          // Â¶ÇÊûúÊ≤°ÊúâÈÄâÊã©‰ªª‰ΩïÊñá‰ª∂Â§πÔºåÁªìÊùüÂ§ÑÁêÜ
          if (selectedFolders.value.length === 0) {
            return;
          }
          
          // Êõ¥Êñ∞ÊúÄÂêéÈÄâÊã©ÁöÑÁ¥¢ÂºïÔºåÁî®‰∫éShiftÂ§öÈÄâ
          const lastSelectedId = selectedFolders.value[selectedFolders.value.length - 1];
          const index = folders.value.findIndex(f => f.id === lastSelectedId);
          if (index !== -1) {
            lastSelectedIndex.value = index;
          }
          
          // Êõ¥Êñ∞ÂΩìÂâçÈÄâ‰∏≠ÁöÑÊñá‰ª∂Â§πÔºàÁî®‰∫éÂè≥ÈîÆËèúÂçïÁ≠âÔºâ
          if (selectedFolders.value.length === 1) {
            const folder = folders.value.find(f => f.id === selectedFolders.value[0]);
            if (folder) {
              selectedFolder.value = folder;
            }
          } else if (selectedFolders.value.length > 1) {
            selectedFolder.value = null;
          } else {
            selectedFolder.value = null;
          }
          
          // ÊòæÁ§∫ÈÄâÊã©‰ø°ÊÅØÂèçÈ¶à
          ElementPlus.ElMessage({
            message: `Â∑≤ÈÄâÊã© ${selectedFolders.value.length} ‰∏™È°πÁõÆ`,
            type: 'success',
            duration: 1500
          });
          
          // Á°Æ‰øùDOMÂíåÊï∞ÊçÆÁöÑÂêåÊ≠•
          // Ëé∑ÂèñÊâÄÊúâÊñá‰ª∂Â§πÂÖÉÁ¥†
          const items = document.querySelectorAll('.folder-item');
          
          // Á°Æ‰øùÈÄâ‰∏≠Áä∂ÊÄÅ‰∏éËßÜËßâÊïàÊûú‰∏ÄËá¥
          items.forEach((el, idx) => {
            const folderId = folders.value[idx].id;
            const isSelected = selectedFolders.value.includes(folderId);
            
            if (isSelected && !el.classList.contains('selected')) {
              el.classList.add('selected');
            } else if (!isSelected && el.classList.contains('selected')) {
              el.classList.remove('selected');
            }
          });
        };
        
        // ÁÇπÂáªÂÖ∂‰ªñÂå∫ÂüüÂÖ≥Èó≠Âè≥ÈîÆËèúÂçï
        const handleClickOutside = () => {
          contextMenuVisible.value = false;
        };

        // Â§ÑÁêÜÊåâÈîÆ‰∫ã‰ª∂
        const handleKeyDown = (event) => {
          // ËÆ∞ÂΩï‰øÆÊîπÈîÆÁä∂ÊÄÅ
          ctrlKeyPressed.value = event.ctrlKey || event.metaKey; // metaKey ÊòØ Mac ‰∏äÁöÑ Command ÈîÆ
          shiftKeyPressed.value = event.shiftKey;
          
          // ESCÈîÆÂÖ≥Èó≠ËèúÂçïÊàñÂèñÊ∂àÈÄâÊã©
          if (event.key === 'Escape') {
            contextMenuVisible.value = false;
            if (selectedFolders.value.length > 0) {
              selectedFolders.value = [];
              lastSelectedIndex.value = -1;
            }
          }
          
          // Ctrl+A ÂÖ®ÈÄâ
          if ((event.ctrlKey || event.metaKey) && event.key === 'a') {
            event.preventDefault(); // Èò≤Ê≠¢ÊµèËßàÂô®ÈªòËÆ§ÂÖ®ÈÄâË°å‰∏∫
            if (folders.value.length > 0) {
              selectedFolders.value = folders.value.map(f => f.id);
            }
          }
          
          // Ctrl+C Â§çÂà∂ÈÄâ‰∏≠È°π
          if ((event.ctrlKey || event.metaKey) && event.key === 'c') {
            if (selectedFolders.value.length > 0) {
              copySelectedFolders();
            }
          }
          
          // Ctrl+V Á≤òË¥¥
          if ((event.ctrlKey || event.metaKey) && event.key === 'v') {
            pasteFolder();
          }
          
          // Delete ÈîÆÂà†Èô§
          if (event.key === 'Delete') {
            if (selectedFolders.value.length > 0) {
              deleteSelectedFolders();
            }
          }
        };
        
        // Â§ÑÁêÜÊåâÈîÆÊùæÂºÄ‰∫ã‰ª∂
        const handleKeyUp = (event) => {
          ctrlKeyPressed.value = event.ctrlKey || event.metaKey;
          shiftKeyPressed.value = event.shiftKey;
        };

        // Â§ÑÁêÜÊãñÊîæÊñá‰ª∂Â§π
        const onDragOver = (event) => {
          isDragging.value = true;
          isDraggingActive.value = true;
        };
        
        const onDragLeave = (event) => {
          isDraggingActive.value = false;
        };
        
        const onDrop = async (event) => {
          isDragging.value = false;
          isDraggingActive.value = false;
          
          // Â§ÑÁêÜÊãñÊîæÁöÑÊñá‰ª∂ÊàñÊñá‰ª∂Â§π
          const items = event.dataTransfer.items;
          if (items) {
            for (let i = 0; i < items.length; i++) {
              const item = items[i];
              // Â∞ùËØï‰Ωú‰∏∫Êñá‰ª∂Â§πÂ§ÑÁêÜ
              if (item.webkitGetAsEntry) {
                const entry = item.webkitGetAsEntry();
                if (entry && entry.isDirectory) {
                  await processDirectoryEntry(entry);
                } else if (entry && entry.isFile) {
                  // Â¶ÇÊûúÊòØÊñá‰ª∂Ôºå‰Ωú‰∏∫ÂçïÁã¨Êñá‰ª∂Â§ÑÁêÜ
                  processFileEntry(entry);
                }
              }
            }
          }
        };
        
        // Â§ÑÁêÜÊñá‰ª∂Â§πÂÖ•Âè£
        const processDirectoryEntry = async (entry) => {
          try {
            if (folders.value.length >= 20) {
              ElementPlus.ElMessage.warning("ÊúÄÂ§öÊñá‰ª∂Â§πÂè™ËÉΩÂàõÂª∫ 20 ‰∏™,ËØ∑ÂÖàÁßªÈô§ÈÉ®ÂàÜÂêéÔºåÂÜçÊ∑ªÂä†!");
              return;
            }
            
            // Ê£ÄÊü•ÊòØÂê¶ÊúâÈáçÂêçÊñá‰ª∂Â§π
            if (folders.value.some(f => f.name === entry.name)) {
              // ÁîüÊàêÊñ∞ÂêçÁß∞
              let baseName = entry.name;
              let extension = '';
              let newName = baseName;
              let counter = 1;
              
              // Â¶ÇÊûúÊúâÊâ©Â±ïÂêçÔºåÂàÜÂºÄÂ§ÑÁêÜ
              const lastDotIndex = baseName.lastIndexOf('.');
              if (lastDotIndex > 0) {
                extension = baseName.substring(lastDotIndex);
                baseName = baseName.substring(0, lastDotIndex);
              }
              
              // ÁîüÊàêÈùûÈáçÂ§çÂêçÁß∞
              while (folders.value.some(f => f.name === newName)) {
                newName = `${baseName}(${counter})${extension}`;
                counter++;
              }
              
              // ÂàõÂª∫‰∏Ä‰∏™Êñ∞Êñá‰ª∂Â§π
              const newFolder = {
                id: nextId++,
                name: newName,
                children: []
              };
              
              folders.value.push(newFolder);
              hasChanges.value = true;
              
              // ÊòæÁ§∫ÈáçÂëΩÂêçÊèêÁ§∫
              ElementPlus.ElMessage({
                message: `Â∑≤Â≠òÂú®ÂêåÂêçÊñá‰ª∂Â§πÔºåÂ∑≤Ëá™Âä®ÈáçÂëΩÂêç‰∏∫: ${newName}`,
                type: 'warning',
                duration: 3000
              });
            } else {
              // ÂàõÂª∫‰∏Ä‰∏™Êñ∞Êñá‰ª∂Â§π
              const newFolder = {
                id: nextId++,
                name: entry.name,
                children: []
              };
              
              folders.value.push(newFolder);
              hasChanges.value = true;
              
              // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
              ElementPlus.ElMessage({
                message: `ÊàêÂäüÊ∑ªÂä†Êñá‰ª∂Â§π: ${entry.name}`,
                type: 'success',
                duration: 2000
              });
            }
          } catch (error) {
            console.error('Â§ÑÁêÜÊñá‰ª∂Â§πÂá∫Èîô:', error);
            ElementPlus.ElMessage.error('Â§ÑÁêÜÊñá‰ª∂Â§πÂá∫Èîô: ' + error.message);
          }
        };
        
        // Â§ÑÁêÜÊñá‰ª∂ÂÖ•Âè£
        const processFileEntry = (entry) => {
          if (folders.value.length >= 20) {
            ElementPlus.ElMessage.warning("ÊúÄÂ§öÊñá‰ª∂Â§πÂè™ËÉΩÂàõÂª∫ 20 ‰∏™,ËØ∑ÂÖàÁßªÈô§ÈÉ®ÂàÜÂêéÔºåÂÜçÊ∑ªÂä†!");
            return;
          }
          
          // Ê£ÄÊü•ÊòØÂê¶ÊúâÈáçÂêçÊñá‰ª∂
          if (folders.value.some(f => f.name === entry.name)) {
            // ÁîüÊàêÊñ∞ÂêçÁß∞
            let baseName = entry.name;
            let extension = '';
            let newName = baseName;
            let counter = 1;
            
            // Â¶ÇÊûúÊúâÊâ©Â±ïÂêçÔºåÂàÜÂºÄÂ§ÑÁêÜ
            const lastDotIndex = baseName.lastIndexOf('.');
            if (lastDotIndex > 0) {
              extension = baseName.substring(lastDotIndex);
              baseName = baseName.substring(0, lastDotIndex);
            }
            
            // ÁîüÊàêÈùûÈáçÂ§çÂêçÁß∞
            while (folders.value.some(f => f.name === newName)) {
              newName = `${baseName}(${counter})${extension}`;
              counter++;
            }
            
            // ‰∏∫Êñá‰ª∂ÂàõÂª∫Êñá‰ª∂Â§πËßÜÂõæ
            const newFolder = {
              id: nextId++,
              name: newName,
              isFile: true
            };
            
            folders.value.push(newFolder);
            hasChanges.value = true;
            
            // ÊòæÁ§∫ÈáçÂëΩÂêçÊèêÁ§∫
            ElementPlus.ElMessage({
              message: `Â∑≤Â≠òÂú®ÂêåÂêçÊñá‰ª∂ÔºåÂ∑≤Ëá™Âä®ÈáçÂëΩÂêç‰∏∫: ${newName}`,
              type: 'warning',
              duration: 3000
            });
          } else {
            // ‰∏∫Êñá‰ª∂ÂàõÂª∫Êñá‰ª∂Â§πËßÜÂõæ
            const newFolder = {
              id: nextId++,
              name: entry.name,
              isFile: true
            };
            
            folders.value.push(newFolder);
            hasChanges.value = true;
            
            // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
            ElementPlus.ElMessage({
              message: `ÊàêÂäüÊ∑ªÂä†Êñá‰ª∂: ${entry.name}`,
              type: 'success',
              duration: 2000
            });
          }
        };
        const clearData = () => {
          ElementPlus.ElMessageBox.confirm(
            'ÊòØÂê¶Ë¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÁöÑÊñá‰ª∂Â§πÂàóË°®?',
            'Warning',
            {
              confirmButtonText: 'ÂêåÊÑè',
              cancelButtonText: 'ÂèñÊ∂à',
              type: 'warning',
            }
          )
          .then(() => {
            ElementPlus.ElMessage({
              type: 'success',
              message: 'Âà†Èô§ÊàêÂäü',
            });
            localStorage.removeItem('folderManager');
            folders.value = [];
            nextId = 1;
            hasChanges.value = false;
            originalData.value = '';
          })
          .catch(() => {
            ElementPlus.ElMessage({
              type: 'info',
              message: 'Êú™Âà†Èô§',
            });
          });
        }
        // ‰øùÂ≠òÊï∞ÊçÆÂà∞Êú¨Âú∞Â≠òÂÇ®
        const saveData = () => {
          try {
            // Ê£ÄÊü•ÊòØÂê¶ÊúâÂèòÊõ¥
            const currentData = JSON.stringify({
              folders: folders.value,
              nextId: nextId
            });
            
            if (!hasChanges.value && currentData === originalData.value) {
              // ‰ΩøÁî® Element Plus ÊòæÁ§∫ÊèêÁ§∫
              ElementPlus.ElMessage({
                message: 'Ê≤°ÊúâÊ£ÄÊµãÂà∞Êñá‰ª∂Â§πÂèòÊõ¥ÔºåÊó†ÈúÄ‰øùÂ≠ò',
                type: 'warning',
                duration: 2000
              });
              return;
            }
            
            localStorage.setItem('folderManager', currentData);
            
            // Êõ¥Êñ∞ÂéüÂßãÊï∞ÊçÆ
            originalData.value = currentData;
            hasChanges.value = false;
            
            // ‰ΩøÁî® Element Plus ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
            ElementPlus.ElMessage({
              message: 'Êï∞ÊçÆÂ∑≤ÊàêÂäü‰øùÂ≠òÂà∞Êú¨Âú∞',
              type: 'success',
              duration: 2000
            });
            
            console.log('Êï∞ÊçÆÂ∑≤‰øùÂ≠òÂà∞Êú¨Âú∞');
          } catch (error) {
            console.error('‰øùÂ≠òÊï∞ÊçÆÂá∫Èîô:', error);
            
            // ‰ΩøÁî® Element Plus ÊòæÁ§∫ÈîôËØØÊèêÁ§∫
            ElementPlus.ElMessage({
              message: '‰øùÂ≠òÊï∞ÊçÆÊó∂Âá∫Èîô: ' + error.message,
              type: 'error',
              duration: 3000
            });
          }
        };
        
        // ‰ªéÊú¨Âú∞Â≠òÂÇ®Âä†ËΩΩÊï∞ÊçÆ
        const loadData = () => {
          try {
            const savedData = localStorage.getItem('folderManager');
            if (savedData) {
              const parsedData = JSON.parse(savedData);
              folders.value = parsedData.folders || [];
              nextId = parsedData.nextId || 1;
              console.log('Êï∞ÊçÆÂ∑≤‰ªéÊú¨Âú∞Âä†ËΩΩ');
              
              // ‰øùÂ≠òÂéüÂßãÊï∞ÊçÆÁî®‰∫éÂèòÊõ¥Ê£ÄÊµã
              originalData.value = savedData;
              hasChanges.value = false;
            }
          } catch (error) {
            console.error('Âä†ËΩΩÊï∞ÊçÆÂá∫Èîô:', error);
            ElementPlus.ElMessage.error('Âä†ËΩΩÊï∞ÊçÆÊó∂Âá∫Èîô: ' + error.message);
          }
        };
        
        // ÁõëÂê¨È°µÈù¢ÂÖ≥Èó≠‰∫ã‰ª∂‰ª•Ëá™Âä®‰øùÂ≠ò
        const handleBeforeUnload = () => {
          if (hasChanges.value) {
            saveData();
          }
        };
        
        // Â§ÑÁêÜÊñá‰ª∂Â§πÁÇπÂáª
        const handleFolderClick = (folder, index, event) => {
          // Èò≤Ê≠¢Âú®ÁºñËæëÊ®°Âºè‰∏ãËß¶ÂèëÈÄâÊã©
          if (editingFolder.value) return;
          
          // Â¶ÇÊûúÊòØÂèåÂáªÔºå‰∫§ÁªôÂèåÂáª‰∫ã‰ª∂Â§ÑÁêÜ
          if (event.detail > 1) return;
          
          // Â¶ÇÊûúÊòØÂè≥ÈîÆÔºå‰∫§ÁªôËèúÂçïÂ§ÑÁêÜ
          if (event.button === 2) return;
          
          // ÂΩìÊåâ‰∏ã Ctrl Êàñ Command ÈîÆ
          if (ctrlKeyPressed.value) {
            const idIndex = selectedFolders.value.indexOf(folder.id);
            if (idIndex === -1) {
              // Ê∑ªÂä†Âà∞ÈÄâ‰∏≠È°π
              selectedFolders.value.push(folder.id);
              lastSelectedIndex.value = index;
            } else {
              // ‰ªéÈÄâ‰∏≠È°πÁßªÈô§
              selectedFolders.value.splice(idIndex, 1);
              lastSelectedIndex.value = selectedFolders.value.length > 0 ? index : -1;
            }
          }
          // ÂΩìÊåâ‰∏ã Shift ÈîÆ
          else if (shiftKeyPressed.value && lastSelectedIndex.value !== -1) {
            // ËÆ°ÁÆóËåÉÂõ¥
            const start = Math.min(lastSelectedIndex.value, index);
            const end = Math.max(lastSelectedIndex.value, index);
            
            // ÈÄâÊã©ËåÉÂõ¥ÂÜÖÁöÑÊâÄÊúâÊñá‰ª∂Â§π
            selectedFolders.value = [];
            for (let i = start; i <= end; i++) {
              if (i < folders.value.length) {
                selectedFolders.value.push(folders.value[i].id);
              }
            }
          }
          // ‰∏çÊåâ‰øÆÈ•∞ÈîÆÊó∂ÔºåÂçïÈÄâ
          else {
            selectedFolders.value = [folder.id];
            lastSelectedIndex.value = index;
          }
        };
        
        // Â§çÂà∂ÈÄâ‰∏≠Êñá‰ª∂Â§π
        const copySelectedFolders = () => {
          if (selectedFolders.value.length === 0) return;
          
          // Â¶ÇÊûúÂè™ÈÄâ‰∫Ü‰∏Ä‰∏™Êñá‰ª∂Â§πÔºå‰ΩøÁî®Âçï‰∏™Â§çÂà∂ÈÄªËæë
          if (selectedFolders.value.length === 1) {
            const folder = folders.value.find(f => f.id === selectedFolders.value[0]);
            if (folder) {
              copyFolder(folder);
            }
            return;
          }
          
          // Â§öÈÄâÂ§çÂà∂ÈÄªËæë
          const selectedItems = folders.value.filter(f => selectedFolders.value.includes(f.id));
          
          // Â≠òÂÇ®Âà∞ÂÜÖÈÉ®Ââ™Ë¥¥Êùø
          clipboardData.value = {
            type: 'multiple',
            items: selectedItems
          };
          
          ElementPlus.ElMessage({
            message: `Â∑≤Â§çÂà∂ ${selectedItems.length} ‰∏™È°πÁõÆ`,
            type: 'success',
            duration: 1500
          });
        };
        
        // Âà†Èô§ÈÄâ‰∏≠Êñá‰ª∂Â§π
        const deleteSelectedFolders = () => {
          if (selectedFolders.value.length === 0) return;
          
          // Â¶ÇÊûúÂè™ÈÄâ‰∫Ü‰∏Ä‰∏™Êñá‰ª∂Â§πÔºå‰ΩøÁî®Âçï‰∏™Âà†Èô§ÈÄªËæë
          if (selectedFolders.value.length === 1) {
            const folder = folders.value.find(f => f.id === selectedFolders.value[0]);
            if (folder) {
              deleteFolder(folder);
            }
            return;
          }
          
          // Â§öÈÄâÂà†Èô§ÈÄªËæë
          ElementPlus.ElMessageBox.confirm(
            `Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${selectedFolders.value.length} ‰∏™È°πÁõÆÂêóÔºü`,
            'ÊâπÈáèÂà†Èô§',
            {
              confirmButtonText: 'Á°ÆÂÆöÂà†Èô§',
              cancelButtonText: 'ÂèñÊ∂à',
              type: 'warning'
            }
          ).then(() => {
            // ËÆ∞ÂΩïË¶ÅÂà†Èô§ÁöÑÈ°πÁõÆÂêçÁß∞
            const itemNames = folders.value
              .filter(f => selectedFolders.value.includes(f.id))
              .map(f => f.name)
              .join(', ');
              
            // ‰ªéÊï∞ÁªÑ‰∏≠ËøáÊª§Âá∫Ë¶ÅÂà†Èô§ÁöÑÈ°πÁõÆ
            folders.value = folders.value.filter(f => !selectedFolders.value.includes(f.id));
            selectedFolders.value = [];
            lastSelectedIndex.value = -1;
            hasChanges.value = true;
            
            ElementPlus.ElMessage({
              message: `Â∑≤Âà†Èô§ÈÄâ‰∏≠È°πÁõÆ: ${itemNames}`,
              type: 'success'
            });
          }).catch(() => {
            ElementPlus.ElMessage({
              type: 'info',
              message: 'Â∑≤ÂèñÊ∂àÂà†Èô§'
            });
          });
        };
        
        // ÁîüÂëΩÂë®ÊúüÈí©Â≠ê
        onMounted(() => {
          document.addEventListener('click', handleClickOutside);
          document.addEventListener('keydown', handleKeyDown);
          document.addEventListener('keyup', handleKeyUp);
          window.addEventListener('beforeunload', handleBeforeUnload);
          
          // Âä†ËΩΩ‰øùÂ≠òÁöÑÊï∞ÊçÆ
          loadData();
        });

        onBeforeUnmount(() => {
          document.removeEventListener('click', handleClickOutside);
          document.removeEventListener('keydown', handleKeyDown);
          document.removeEventListener('keyup', handleKeyUp);
          window.removeEventListener('beforeunload', handleBeforeUnload);
        });

        // Â§çÂà∂Êñá‰ª∂Â§π
        const copyFolder = (folder) => {
          // Â≠òÂÇ®Âú®ÂÜÖÈÉ®Ââ™Ë¥¥Êùø‰∏≠
          clipboardData.value = { ...folder };
          
          // Â∞ùËØïÂ∞ÜÊï∞ÊçÆÂÜôÂÖ•Á≥ªÁªüÂâ™Ë¥¥Êùø
          try {
            navigator.clipboard.writeText(JSON.stringify(folder))
              .then(() => {
                ElementPlus.ElMessage({
                  message: `Â∑≤Â§çÂà∂Êñá‰ª∂Â§πÔºö${folder.name}`,
                  type: 'success',
                  duration: 1500
                });
              })
              .catch(err => {
                console.warn('ÂÜôÂÖ•Á≥ªÁªüÂâ™Ë¥¥ÊùøÂá∫ÈîôÔºå‰ΩÜÂÜÖÈÉ®Ââ™Ë¥¥ÊùøÂèØÁî®', err);
                ElementPlus.ElMessage({
                  message: `Â∑≤Â§çÂà∂Êñá‰ª∂Â§πÔºö${folder.name} (‰ªÖÂ∫îÁî®ÂÜÖÂèØÁî®)`,
                  type: 'success',
                  duration: 1500
                });
              });
          } catch (e) {
            // Â¶ÇÊûúÊµèËßàÂô®‰∏çÊîØÊåÅÂâ™Ë¥¥Êùø APIÔºå‰æùÁÑ∂ÂèØ‰ΩøÁî®ÂÜÖÈÉ®Ââ™Ë¥¥Êùø
            ElementPlus.ElMessage({
              message: `Â∑≤Â§çÂà∂Êñá‰ª∂Â§πÔºö${folder.name} (‰ªÖÂ∫îÁî®ÂÜÖÂèØÁî®)`,
              type: 'success',
              duration: 1500
            });
          }
          contextMenuVisible.value = false;
        };
        
        // Á≤òË¥¥Êñá‰ª∂Â§π
        const pasteFolder = async () => {
          // Ê£ÄÊü•Êï∞ÈáèÈôêÂà∂
          if (folders.value.length >= 20) {
            ElementPlus.ElMessage.warning("ÊúÄÂ§öÊñá‰ª∂Â§πÂè™ËÉΩÂàõÂª∫ 20 ‰∏™,ËØ∑ÂÖàÁßªÈô§ÈÉ®ÂàÜÂêéÔºåÂÜçÊ∑ªÂä†!");
            contextMenuVisible.value = false;
            return;
          }
          
          // ‰ºòÂÖàÂ∞ùËØï‰ΩøÁî®ÂÜÖÈÉ®Ââ™Ë¥¥Êùø
          if (clipboardData.value) {
            // Ê£ÄÊü•ÊòØÂê¶ÊòØÊâπÈáèÂ§çÂà∂
            if (clipboardData.value.type === 'multiple' && clipboardData.value.items) {
              // ÊâπÈáèÁ≤òË¥¥ÈÄªËæë
              const items = clipboardData.value.items;
              
              // Ê£ÄÊü•ÊòØÂê¶Ë∂ÖËøáÊï∞ÈáèÈôêÂà∂
              if (folders.value.length + items.length > 20) {
                ElementPlus.ElMessage.warning(`ÊúÄÂ§ö‰ªÖËÉΩÂàõÂª∫ 20 ‰∏™È°πÁõÆ„ÄÇÂΩìÂâç ${folders.value.length} ‰∏™Ôºå‰∏çËÉΩÂÜçÊ∑ªÂä† ${items.length} ‰∏™`);
                return;
              }
              
              // ÊâπÈáèÂàõÂª∫Êñá‰ª∂Â§π
              const newFolders = [];
              
              for (const item of items) {
                // ÁîüÊàêÊñ∞ÂêçÁß∞Èò≤Ê≠¢ÈáçÂ§ç
                let baseName = item.name;
                let extension = '';
                let newName = baseName;
                let counter = 1;
                
                // Â¶ÇÊûúÊúâÊâ©Â±ïÂêçÔºåÂàÜÂºÄÂ§ÑÁêÜ
                const lastDotIndex = baseName.lastIndexOf('.');
                if (lastDotIndex > 0 && item.isFile) {
                  extension = baseName.substring(lastDotIndex);
                  baseName = baseName.substring(0, lastDotIndex);
                }
                
                // Ê£ÄÊü•Â∑≤ÊúâÊñá‰ª∂Â§πÂèäÊñ∞ÂàõÂª∫ÁöÑÊñá‰ª∂Â§π‰∏≠ÊòØÂê¶ÊúâÈáçÂêç
                const existingNames = [...folders.value.map(f => f.name), ...newFolders.map(f => f.name)];
                while (existingNames.includes(newName)) {
                  newName = `${baseName} ÁöÑÂâØÊú¨${counter > 1 ? ' ' + counter : ''}${extension}`;
                  counter++;
                }
                
                // ÂàõÂª∫Êñ∞Êñá‰ª∂Â§π
                const newFolder = {
                  id: nextId++,
                  name: newName,
                  isFile: item.isFile || false,
                  children: item.children || []
                };
                
                newFolders.push(newFolder);
              }
              
              // Ê∑ªÂä†Âà∞ÂΩìÂâçÊñá‰ª∂Â§πÂàóË°®
              folders.value.push(...newFolders);
              hasChanges.value = true;
              
              ElementPlus.ElMessage({
                message: `ÊàêÂäüÁ≤òË¥¥ ${newFolders.length} ‰∏™È°πÁõÆ`,
                type: 'success',
                duration: 1500
              });
              
              contextMenuVisible.value = false;
              return;
            }
            // ÁîüÊàêÊñ∞Êñá‰ª∂Â§πÂêçÁß∞
            let baseName = clipboardData.value.name;
            let extension = '';
            let newName = baseName;
            let counter = 1;
            
            // Â¶ÇÊûúÊúâÊâ©Â±ïÂêçÔºåÂàÜÂºÄÂ§ÑÁêÜ
            const lastDotIndex = baseName.lastIndexOf('.');
            if (lastDotIndex > 0 && clipboardData.value.isFile) {
              extension = baseName.substring(lastDotIndex);
              baseName = baseName.substring(0, lastDotIndex);
            }
            
            // Ê£ÄÊü•ÈáçÂêçÂπ∂ÁîüÊàêÊñ∞ÂêçÁß∞
            while (folders.value.some(f => f.name === newName)) {
              newName = `${baseName} ÁöÑÂâØÊú¨${counter > 1 ? ' ' + counter : ''}${extension}`;
              counter++;
            }
            
            // ÂàõÂª∫Êñ∞Êñá‰ª∂Â§π
            const newFolder = {
              id: nextId++,
              name: newName,
              isFile: clipboardData.value.isFile || false,
              children: clipboardData.value.children || []
            };
            
            folders.value.push(newFolder);
            hasChanges.value = true;
            contextMenuVisible.value = false;
            
            ElementPlus.ElMessage({
              message: `ÊàêÂäüÁ≤òË¥¥Êñá‰ª∂Â§π: ${newName}`,
              type: 'success',
              duration: 1500
            });
            return;
          }
          
          // Â¶ÇÊûúÂÜÖÈÉ®Ââ™Ë¥¥Êùø‰∏∫Á©∫ÔºåÂ∞ùËØï‰ªéÁ≥ªÁªüÂâ™Ë¥¥ÊùøËØªÂèñ
          try {
            const text = await navigator.clipboard.readText();
            try {
              const data = JSON.parse(text);
              if (data && data.name) {
                // ÁîüÊàêÊñ∞Êñá‰ª∂Â§πÂêçÁß∞
                let baseName = data.name;
                let newName = baseName;
                let counter = 1;
                
                // Ê£ÄÊü•ÈáçÂêçÂπ∂ÁîüÊàêÊñ∞ÂêçÁß∞
                while (folders.value.some(f => f.name === newName)) {
                  newName = `${baseName} ÁöÑÂâØÊú¨${counter > 1 ? ' ' + counter : ''}`;
                  counter++;
                }
                
                // ÂàõÂª∫Êñ∞Êñá‰ª∂Â§π
                const newFolder = {
                  id: nextId++,
                  name: newName,
                  isFile: data.isFile || false
                };
                
                folders.value.push(newFolder);
                hasChanges.value = true;
                contextMenuVisible.value = false;
                
                ElementPlus.ElMessage({
                  message: `ÊàêÂäü‰ªéÂâ™Ë¥¥ÊùøÁ≤òË¥¥: ${newName}`,
                  type: 'success',
                  duration: 1500
                });
              } else {
                throw new Error('Êó†ÊïàÁöÑÊñá‰ª∂Â§πÊï∞ÊçÆ');
              }
            } catch (parseError) {
              // JSON Ëß£ÊûêÂ§±Ë¥•ÔºåÂ∞ùËØïÂ∞ÜÊñáÊú¨‰Ωú‰∏∫Êñá‰ª∂ÂêçÂàõÂª∫
              if (text.trim()) {
                // ÁîüÊàêÊñ∞Êñá‰ª∂Â§πÂêçÁß∞
                let baseName = text.length > 20 ? text.substring(0, 20) + '...' : text;
                let newName = baseName;
                let counter = 1;
                
                // Ê£ÄÊü•ÈáçÂêçÂπ∂ÁîüÊàêÊñ∞ÂêçÁß∞
                while (folders.value.some(f => f.name === newName)) {
                  newName = `${baseName} (${counter})`;
                  counter++;
                }
                
                // ÂàõÂª∫Êñ∞Êñá‰ª∂Â§π
                const newFolder = {
                  id: nextId++,
                  name: newName,
                  isFile: true
                };
                
                folders.value.push(newFolder);
                hasChanges.value = true;
                contextMenuVisible.value = false;
                
                ElementPlus.ElMessage({
                  message: `Â∑≤Â∞ÜÂâ™Ë¥¥ÊùøÊñáÊú¨ÂàõÂª∫‰∏∫Êñá‰ª∂: ${newName}`,
                  type: 'success',
                  duration: 1500
                });
              } else {
                ElementPlus.ElMessage({
                  message: 'Ââ™Ë¥¥Êùø‰∏≠Êó†ÂèØÁ≤òË¥¥ÁöÑÂÜÖÂÆπ',
                  type: 'warning',
                  duration: 1500
                });
              }
            }
          } catch (error) {
            ElementPlus.ElMessage({
              message: 'Êó†Ê≥ïËÆøÈóÆÁ≥ªÁªüÂâ™Ë¥¥ÊùøÔºåËØ∑ÂÖàÂ§çÂà∂Êñá‰ª∂Â§π',
              type: 'error',
              duration: 1500
            });
          }
          contextMenuVisible.value = false;
        };

        return {
          folders,
          contextMenuVisible,
          contextMenuTop,
          contextMenuLeft,
          selectedFolder,
          editingFolder,
          editInput,
          tempName,
          isDragging,
          isDraggingActive,
          hasChanges,
          clipboardData,
          selectedFolders,
          hoveredFolderId,
          isSelectionActive,
          selectionStart,
          selectionCurrent,
          showContextMenu,
          createNewFolder,
          startEdit,
          finishEdit,
          cancelEdit,
          deleteFolder,
          copyFolder,
          pasteFolder,
          handleFolderClick,
          handleContainerClick,
          copySelectedFolders,
          deleteSelectedFolders,
          selectAllFolders,
          clearSelection,
          onFolderMouseOver,
          onFolderMouseLeave,
          startDragSelection,
          updateDragSelection,
          endDragSelection,
          // ÊãñÊãΩÁõ∏ÂÖ≥ÂáΩÊï∞
          handleDragStart,
          handleDragOver,
          handleDrop,
          onDragOver,
          onDragLeave,
          onDrop,
          saveData,
          clearData
        };
      }
    });
    
    // ‰ΩøÁî® Element Plus
    app.use(ElementPlus);
    
    // ÊåÇËΩΩÂ∫îÁî®
    app.mount('#app');
  </script>
</body>
</html>
